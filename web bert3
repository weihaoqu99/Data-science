import traceback
import evaluate  # local bertscore.py
import torch
import pandas as pd
from pathlib import Path

# Set local model and baseline paths (no "en/" subfolder)
MODEL_PATH = r"C:/Users/ZKC7HOU/Documents/4. BERT score/roberta-large"
BASELINE_PATH = r"C:/Users/ZKC7HOU/Documents/4. BERT score/roberta-large/roberta-large.tsv"
DEVICE = "cuda" if torch.cuda.is_available() else "cpu"

# Load BERTScore metric
try:
    scorer = evaluate.load("bertscore")
    print("✔ Loaded local BERTScore metric")
except Exception as e:
    print("❌ Failed to load BERTScore metric:", e)
    scorer = None

# BERTScore batch scoring from Excel
def run_bertscore_on_excel(input_path: str, output_path: str):
    if scorer is None:
        raise RuntimeError("Metric failed to load")

    df = pd.read_excel(input_path)

    for col in ("reference", "candidate"):
        if col not in df.columns:
            raise ValueError(f"❌ Missing column: {col}")

    references = df["reference"].astype(str).str.strip().tolist()
    candidates = df["candidate"].astype(str).str.strip().tolist()

    if len(references) != len(candidates):
        raise ValueError("❌ Length mismatch between reference and candidate columns")

    try:
        result = scorer.compute(
            predictions=candidates,
            references=references,
            model_type=MODEL_PATH,
            num_layers=17,
            device=DEVICE,
            rescale_with_baseline=True,
            baseline_path=BASELINE_PATH,
            lang="en"
        )

        df["precision"] = [round(min(max(p, 0.0), 1.0), 6) for p in result["precision"]]
        df["recall"] = [round(min(max(r, 0.0), 1.0), 6) for r in result["recall"]]
        df["f1"] = [round(min(max(f, 0.0), 1.0), 6) for f in result["f1"]]

        df.to_excel(output_path, index=False)
        print(f"✅ Results saved to: {output_path}")

    except Exception as e:
        print(traceback.format_exc())
        raise RuntimeError(f"Scoring failed: {e}")

# Example Usage
if __name__ == "__main__":
    input_file = r"C:/Users/ZKC7HOU/Documents/4. BERT score/input_data.xlsx"
    output_file = r"C:/Users/ZKC7HOU/Documents/4. BERT score/output_data.xlsx"
    run_bertscore_on_excel(input_file, output_file)