#!/usr/bin/env python
import os
import sys
import argparse
from pathlib import Path

import pandas as pd
from bert_score import BERTScorer

# ─── Monkey-patch HF repo-id validator so Windows paths aren’t rejected ─────
try:
    import huggingface_hub.utils.validators as _val
    _val.validate_repo_id = lambda *a, **k: None
except ImportError:
    pass
# ─────────────────────────────────────────────────────────────────────────────

def main():
    parser = argparse.ArgumentParser(description="Compute BERTScore offline")
    parser.add_argument(
        "--output_dir",
        type=Path,
        required=True,
        help="Directory to write Bertscore_output.xlsx"
    )
    parser.add_argument(
        "files",
        nargs="+",
        help="Input .csv/.xls/.xlsx files with 'reference' & 'candidate' columns"
    )
    args = parser.parse_args()

    # 1) your local model & baseline paths
    cache_dir     = Path(r"C:/Users/ZKC7HOU/Documents/4. BERT score/roberta-large")
    baseline_path = Path(r"C:/Users/ZKC7HOU/Documents/4. BERT score/roberta-large/Versions-delete/roberta-large.tsv")

    # 2) force offline & point cache
    os.environ["TRANSFORMERS_OFFLINE"] = "1"
    os.environ["HF_HUB_OFFLINE"]       = "1"
    os.environ["TRANSFORMERS_CACHE"]   = str(cache_dir)

    # 3) init BERTScorer from your local folder only
    try:
        scorer = BERTScorer(
            lang="en",
            rescale_with_baseline=True,
            model_type=str(cache_dir),      # pass the local path
            baseline_path=str(baseline_path),
            num_layers=24,
            device="cuda" if os.getenv("CUDA_VISIBLE_DEVICES") else "cpu"
        )
    except Exception as e:
        print("ERROR: failed to init BERTScorer:", e, file=sys.stderr)
        sys.exit(1)

    # 4) read & concatenate all input files
    dfs = []
    for fn in args.files:
        p = Path(fn)
        if p.suffix.lower() in (".xls", ".xlsx"):
            dfs.append(pd.read_excel(p))
        elif p.suffix.lower() == ".csv":
            dfs.append(pd.read_csv(p))
        else:
            print(f"ERROR: unsupported file type {p.suffix}", file=sys.stderr)
            sys.exit(1)
    df = pd.concat(dfs, ignore_index=True)

    # 5) ensure required columns exist
    for col in ("reference", "candidate"):
        if col not in df.columns:
            print(f"ERROR: missing column '{col}'", file=sys.stderr)
            sys.exit(1)

    # 6) compute BERTScore (precision, recall, f1)
    P, R, F1 = scorer.score(
        cands=df["candidate"].astype(str).tolist(),
        refs=[[r] for r in df["reference"].astype(str).tolist()]
    )
    df["precision"] = [round(x, 6) for x in P.tolist()]
    df["recall"]    = [round(x, 6) for x in R.tolist()]
    df["f1"]        = [round(x, 6) for x in F1.tolist()]

    # 7) write out the result Excel
    out_dir   = args.output_dir
    out_dir.mkdir(parents=True, exist_ok=True)
    output_fp = out_dir / "Bertscore_output.xlsx"
    df.to_excel(output_fp, index=False)

    # 8) final success message
    print(f"✔️ Report saved to: {output_fp.resolve()}")

if __name__ == "__main__":
    main()